# yday Complete Setup Guide

This guide walks you through setting up:
1. ProtonMail Bridge (for email IMAP - FREE, uses your existing ProtonMail Duo)
2. DNS configuration (connecting yday.ai)
3. GitHub Pages deployment
4. Email ingestion with IMAP polling

---

## Part 1: ProtonMail Bridge Setup (~15 minutes, FREE)

Since you already have ProtonMail Duo with custom domain, we'll use ProtonMail Bridge for IMAP access.

### Step 1: Install ProtonMail Bridge on Your Backend Server

**On your DigitalOcean backend server:**

1. SSH into your server
2. Install ProtonMail Bridge:

```bash
# For Ubuntu/Debian
# Check latest version at: https://proton.me/mail/bridge
wget https://proton.me/download/bridge/protonmail-bridge_3.x.x_amd64.deb
sudo dpkg -i protonmail-bridge_3.x.x_amd64.deb

# Or install via package manager if available
# For the latest installation instructions, visit:
# https://proton.me/mail/bridge#install
```

3. Start ProtonMail Bridge:
```bash
protonmail-bridge --noninteractive
```

4. On first run, it will ask you to log in. Use your ProtonMail credentials.
5. Bridge will start and show you IMAP/SMTP credentials:
   - **IMAP**: `127.0.0.1:1143`
   - **SMTP**: `127.0.0.1:1025`
   - **Username**: Your ProtonMail email
   - **Password**: Bridge app password (generated by Bridge - save this!)

### Step 2: Configure Bridge to Run as Service

Create a systemd service so Bridge runs automatically:

```bash
sudo nano /etc/systemd/system/protonmail-bridge.service
```

Add:
```ini
[Unit]
Description=ProtonMail Bridge
After=network.target

[Service]
Type=simple
User=your-username
ExecStart=/usr/bin/protonmail-bridge --noninteractive
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

Enable and start:
```bash
sudo systemctl enable protonmail-bridge
sudo systemctl start protonmail-bridge
sudo systemctl status protonmail-bridge  # Check it's running
```

### Step 3: Add Environment Variables to DigitalOcean

In your DigitalOcean App Platform environment variables, add:

- `PROTONMAIL_IMAP_HOST` = `127.0.0.1`
- `PROTONMAIL_IMAP_PORT` = `1143`
- `PROTONMAIL_IMAP_USER` = `your-email@yday.ai` (or your ProtonMail email)
- `PROTONMAIL_IMAP_PASSWORD` = (Bridge app password from Step 1)
- `PROTONMAIL_SMTP_HOST` = `127.0.0.1`
- `PROTONMAIL_SMTP_PORT` = `1025`
- `PROTONMAIL_SMTP_USER` = (same as IMAP user)
- `PROTONMAIL_SMTP_PASSWORD` = (same as IMAP password)
- `PROTONMAIL_FROM_EMAIL` = `scan@yday.ai`
- `SCAN_EMAIL_ADDRESS` = `scan@yday.ai`
- `EMAIL_POLL_INTERVAL` = `120` (check every 2 minutes)

**Note**: If your backend runs in a container, you may need to run Bridge in a separate container or use a different approach. Check DigitalOcean's documentation for running services alongside your app.

### Step 4: Create scan@yday.ai Address in ProtonMail

1. Log into ProtonMail web interface
2. Go to Settings → Addresses
3. Create new address: `scan@yday.ai`
4. This is where users will send record photos

### Step 5: Deploy Updated Backend

After adding the email service code and environment variables:
1. Commit and push your changes
2. DigitalOcean will auto-deploy
3. Check logs to see: "✅ Email service started"

### Step 6: Test It

1. Send an email to `scan@yday.ai` with a record photo
2. Wait 1-2 minutes (polling interval)
3. Check backend logs for processing
4. You should receive a reply with the scan results

---

## Part 2: DNS Configuration

Make sure your DNS is set up correctly for ProtonMail:

### MX Records (for email delivery)

In GoDaddy DNS, add ProtonMail MX records:

| Type | Name | Priority | Value | TTL |
|------|------|----------|-------|-----|
| MX | @ | 10 | mail.protonmail.ch | 1 hour |
| MX | @ | 20 | mailsec.protonmail.ch | 1 hour |

### TXT Records (for SPF and verification)

| Type | Name | Value | TTL |
|------|------|-------|-----|
| TXT | @ | `v=spf1 include:_spf.protonmail.ch mx ~all` | 1 hour |

(ProtonMail will provide exact values in their settings - check Settings → Domain)

### A Records (for website - GitHub Pages)

| Type | Name | Value | TTL |
|------|------|-------|-----|
| A | @ | 185.199.108.153 | 1 hour |
| A | @ | 185.199.109.153 | 1 hour |
| A | @ | 185.199.110.153 | 1 hour |
| A | @ | 185.199.111.153 | 1 hour |

### CNAME Record (for www)

| Type | Name | Value | TTL |
|------|------|-------|-----|
| CNAME | www | s1umpp.github.io | 1 hour |

---

## Part 3: Deploy Website to GitHub Pages

### Step 1: Build and Deploy

```bash
cd /Users/joshua/projects/yday_web_temp/web
npm install
npm run deploy
```

This creates a `gh-pages` branch with the built site.

### Step 2: Configure GitHub Pages

1. Go to: https://github.com/s1umpp/yday_web/settings/pages
2. Source: **Deploy from a branch**
3. Branch: **gh-pages** / **(root)**
4. Click Save
5. Custom domain: Enter `www.yday.ai`
6. Check **Enforce HTTPS** (may take a few minutes to be available)

### Step 3: Wait for DNS Propagation

- DNS changes can take 5-60 minutes
- Check status at: https://dnschecker.org/#A/yday.ai

---

## Summary Checklist

- [ ] Install ProtonMail Bridge on backend server
- [ ] Configure Bridge as systemd service
- [ ] Get IMAP/SMTP credentials from Bridge
- [ ] Add environment variables to DigitalOcean
- [ ] Create scan@yday.ai address in ProtonMail
- [ ] Add MX records for ProtonMail in GoDaddy
- [ ] Add TXT records for SPF
- [ ] Add A records for website
- [ ] Add CNAME record for www
- [ ] Deploy website: `npm run deploy`
- [ ] Configure GitHub Pages
- [ ] Deploy updated backend code
- [ ] Test by emailing scan@yday.ai

---

## Estimated Costs

| Service | Cost |
|---------|------|
| ProtonMail Duo | Already paying |
| DigitalOcean Backend | Already paying |
| GitHub Pages | Free |
| GoDaddy domain | Already paying |
| **Total Extra Cost** | **$0** |

---

## Security Benefits

✅ No public webhook endpoints  
✅ Authenticated IMAP connection  
✅ You control polling frequency  
✅ ProtonMail spam filtering  
✅ Minimal attack surface  
✅ Emails stay in your ProtonMail account  

---

## Troubleshooting

### Bridge won't start
- Check logs: `journalctl -u protonmail-bridge -f`
- Make sure Bridge is logged in: `protonmail-bridge --cli`
- Verify credentials are correct

### Emails not being processed
- Check backend logs for "Email service started"
- Verify environment variables are set correctly
- Test IMAP connection manually:
  ```python
  import imaplib
  mail = imaplib.IMAP4('127.0.0.1', 1143)
  mail.login('your-email@yday.ai', 'bridge-password')
  ```

### Replies not sending
- Check SMTP credentials
- Verify Bridge is running: `systemctl status protonmail-bridge`
- Test SMTP connection manually

---

## Need Help?

If you get stuck on any step, let me know and I can help troubleshoot!
